# STM32F103C8T6开发环境搭建

## 1 环境配置

Keil5安装

STMF1芯片开发包安装

调试工具驱动安装：ST-LINK，JLINK（均需要安装调试工具的驱动）：此电脑->管理->设备管理器

USB转串口（CH340）调试工具驱动安装



## 2 新建STM32工程

### 2.1 三种开发方式

基于寄存器方式：程序直接配置寄存器，最底层，最直接，最高效

**基于标准库（库函数）方式**：ST官方有封装好的函数，通过调用这些函数，间接配置寄存器，提高了开发效率。需要配置STM32库函数的压缩包。

基于HAL库方式：图形化配置ST32，适合快速上手，但是隐藏了底层逻辑

### 2.2 Keil5新建STM32工程

- Project -> New μVision Project ->新建工程文件夹并保存。新建工程时，选择本次实验用到的芯片型号：STM32F1系列，**STM32 F103C8T6**。注意默认情况下，Keil5没有STM32开发支持包，需要下载并安装官网的apck包，或者使用借助Pack Installer工具，找到所需的支持包进行安装。

- 根据芯片型号，提供相应固件库中的Libararies文件夹中的必要工程文件：stm32f10x.h头文件外设寄存器描述文件，system配置时钟头文件及实现文件，以及STM32启动所需要的.s文件。

  在STM32F10x_stdPeriph_Lib_V3.5.0->Libaraies->CMSIS>CM3->**DeviceSupport**->ST->STM32F10x->startup->arm下的全部启动文件，.s文件。

  STM32的程序就是从启动文件开始执行的。在新建工程文件夹下，新建文件夹Start，并将全部.s启动文件放入其中。

  > 头文件`stm32f10x.h`是STM32的外设寄存器描述文件，描述了STM32有哪些寄存器和它们的地址。两个system_stm32f10x文件是用于配置时钟的。比如STM32的主频是72MHz，就是在system文件中的函数配置的。`#define SYSCLK_FREQ_24MHz  24000000`。该头文件与51单片机的头文件`REGX52.h`作用是一样的。
  >
  > 需要将STM32启动程序和外设寄存器描述头文件，以及系统时钟文件拷贝到工程文件夹中。
  >
  > 固件库中的Project文件夹是官方提供的工程示例和模板，使用库函数时可进行参考。



- 上边完成了，STM32的启动文件和外设寄存器描述文件的工程配置。因为STM32是由内核和内核外围的设备组成的，且内核寄存器描述和外围设备的描述文件不是在一起的。所以还需要添加一个**内核寄存器描述文件**。具体路径在 STM32F10x_stdPeriph_Lib_V3.5.0->Libaraies->CMSIS->CM3->CoreSupport中的core_cm3.c和core_cm3.h。两个内核寄存器描述文件，还包括一些内核的配置函数，也一并复制到工程文件夹中的Start文件夹下。

- 启动文件的选择：startup_stm32f10x_md.s。添加头文件夹路径：.\Start
- 添加User文件夹和main.c文件，**注意文件最后一行必须是空行**，否则会报警。
- 记得更改ST_Link调试器，并在Flas Download中勾选Rest and Run，或者每次烧录程序后按板子上的reset复位键，才执行程序。接上电源后，STm32测试程序的D2灯不断闪烁，电源灯D1常亮。load后，D2不再闪烁。

> 总结步骤：
>
> - 建立工程文件夹，Keil中新建工程，选择对应芯片型号
> - 工程文件夹中新建Start，Library，User文件夹，复制固件库中的文件到工程文件夹中
> - 工程里Target文件夹下新建对应的Start，Library，User灯同名分组，然后将文件添加到工程分组中
> - 工程选项Options for Target中，在C/C++选项卡中，Include Paths内声明所有包含头文件的文件夹相对路径
> - 工程选项的C/C++选项卡，Define内定义USE_STDPERIPH_DRIVER，保证#include "stm32f10x_conf.h"的正常包含
> - 工程选项的Debug选项卡中，Use下拉列表中选择对应调试器ST-Link Debugger，并点击Settings按钮，将Flash Download里勾选Reset and Run，目的是每次烧录程序后，可以自动复位并执行程序。

### 2.3 工程文件的整体结构

Start

Library

User



> **DFP文件**通常指的是Device Family Pack（设备系列包）文件。在芯片工程中，DFP文件包含了特定系列的芯片所需的驱动程序、示例代码和配置文件等信息。这些文件能够帮助开发人员轻松地在集成开发环境（IDE）中配置和使用特定系列的芯片，提供了对硬件外设的支持，简化了芯片的开发过程。DFP文件通常由芯片厂商提供，并与IDE集成，以便开发人员能够更方便地进行软件开发和调试。
>
>
> 在芯片工程中，**CMSIS**（Cortex Microcontroller Software Interface Standard）通常是一个文件夹，其中包含了与ARM Cortex-M处理器相关的标准外设驱动程序和中间件。这些文件通常包括头文件（.h）、源文件（.c）以及其他必要的文件，用于支持芯片的外设驱动和软件开发。通过使用CMSIS，开发人员可以更方便地编写与Cortex-M处理器兼容的代码，提高开发效率并降低移植成本。
>
> **Cortex-M处理器**是由ARM（Advanced RISC Machines）公司设计的一系列32位嵌入式处理器。它们专为低功耗、实时应用和成本敏感型设备而设计，如物联网（IoT）设备、传感器、工业控制器和消费类电子产品等。
>
> Cortex-M处理器具有精简指令集计算架构（RISC），具备高性能和能效优势。该系列处理器包括多个不同的型号，如Cortex-M0、Cortex-M0+、Cortex-M1、Cortex-M3、Cortex-M4和Cortex-M7等，每个型号在处理能力、内存管理、浮点运算、中断处理和外设支持等方面会有所差异。
>
> Cortex-M处理器广泛应用于嵌入式系统中，提供了可靠的执行环境和丰富的软件生态系统，使开发人员能够快速开发出高效、可靠的嵌入式应用程序。
>
> STM32芯片固件库：https://blog.csdn.net/cbkdgq/article/details/88076843

### 2.4 MDK 工程文件类型

![image-20240701232330560](.\STM32F103C8T6开发环境搭建.assets\image-20240701232330560.png)